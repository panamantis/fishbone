<!DOCTYPE html>
<html class="wf-nytcheltenham-n2-active wf-nytcheltenham-n7-active wf-nytkarnakdisplay130124-n4-active wf-nytfranklin-n3-active wf-nytfranklin-n5-active wf-active"><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8"><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=Edge">
<title>Card Sorter</title>
<meta name="robots" content="noarchive">
<meta name="viewport" content="width=1100">
<meta name="dat" content="September 13, 2013">
<meta name="DISPLAYDATE" content="September 13, 2013">
<meta name="pdate" content="20130913">
<meta name="col" content="">
<meta name="tom" content="interactive_feature">
<meta name="display-text" content="Interactive Feature">
<meta name="display-name" content="interactive">
<meta name="url_thumb" content="http://graphics8.nytimes.com/newsgraphics/2013/09/13/fashion-week-editors-picks/e2e355157a66c53141657c4af5431fed6add83f7/fashion-75x75.png">
<meta name="url_thumb_wide" content="http://graphics8.nytimes.com/newsgraphics/2013/09/13/fashion-week-editors-picks/e2e355157a66c53141657c4af5431fed6add83f7/fashion-190x126.png">
<meta name="ttl" content="">
<meta name="per" content="">
<meta name="misspelling" content="">
<meta name="MEDIA_TEMPLATE_VERSION" content="200">
<meta name="asset_id" content="">
<meta name="CG" content="fashion">
<meta name="SCG" content="">
<meta name="PT" content="Multimedia">
<meta name="PST" content="Interactive">
<meta property="og:type" content="article">
<meta property="og:title" content="Front Row to Fashion Week">
<meta property="og:description" content="Of the more than 300 collections shown during New York Fashion Week, here were the ones that created the most buzz.">
<meta property="og:url" content="http://www.nytimes.com/newsgraphics/2013/09/13/fashion-week-editors-picks/">
<meta property="og:image" content="http://graphics8.nytimes.com/newsgraphics/2013/09/13/fashion-week-editors-picks/e2e355157a66c53141657c4af5431fed6add83f7/fashion-twittercard.png">
<link rel="image_src" href="http://graphics8.nytimes.com/newsgraphics/2013/09/13/fashion-week-editors-picks/e2e355157a66c53141657c4af5431fed6add83f7/fashion-twittercard.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="TimesPeople" content="disallow">

<style type="text/css">

body {
  background: #161616;
  position: relative;
  color: #aaa;
  margin: 0;
  min-width: 970px;
}

a {
  text-decoration: none;
}

a:hover {
  text-decoration: underline
}

/* Branding */

.branding {
  color: white;
  position: relative;
  padding-top: 17px;
  margin: 0 5%;
}

.branding a {
  color: #959595;
}

.branding a:hover {
  text-decoration: none;
  color: white;
}

.branding .logo {
  background: url("http://graphics8.nytimes.com/newsgraphics/2013/09/13/fashion-week-editors-picks/e2e355157a66c53141657c4af5431fed6add83f7/logo.png") center center no-repeat;
  float: left;
  width: 133px;
  height: 19px;
  margin-right: 10px;
  padding: 0;
  opacity: 0.7;
}

.branding .logo:hover {
  opacity: 1;
}

.branding .section {
  vertical-align: top;
  font-family: "nyt-karnak-display-130124", sans-serif;
  font-style: normal;
  font-weight: 400;
  font-size: 12px;
  text-transform: uppercase;
  float: left;
  border-left: 1px solid #575757;
  line-height: 23px;
  padding-left: 10px;
  padding-top: 3px;
  margin-top: -3px;
}

.branding .nyt-tools {
  float: right;
}

/* Head */

#BIG_AD {
  width: 300px;
  height: 250px;
  background: #222;
  position: absolute;
  right: 5%;
  top: 0;
}

.header {
  clear: both;
  padding: 0 5%;
  position: relative;
  height: 270px;
}

.header h1 {
  font-family: "nyt-cheltenham", "NYTCheltenham-ExtraLight", Georgia, sans-serif;
  font-style: normal;
  font-weight: 200;
  margin-top: 0px;
  margin-bottom: 0;
  color: white;
  font-size: 50px;
  -webkit-font-smoothing: antialiased;
}

.header-summary {
  color: #999;
  font: 17px/23px "nyt-franklin", Arial;
  font-weight: 200;
  width: 50%;
  margin-top: 12px;
}

.collection-fingerprints .header-summary {
  margin-top: -20px;
  margin-bottom: 60px;
}

.dateline {
  color: #777;
  font-family: Arial;
  font-size: 11px;
  overflow: hidden;
  margin-top: 13px;
}

.dateline .date {
  margin-left: 10px;
  padding-left: 10px;
  border-left: solid 1px #444;
}

.byline span {
  text-transform: uppercase;
}

.dateline .byline, .dateline .date {
  float: left;
}

/* Graphic */

.graphic {
  margin: 15px 0 0 0;
  padding: 40px 5%;
  background: #222;
  overflow: hidden;
}

.graphic a {
  color: white;
  text-decoration: none;
}

.graphic a:hover {
  text-decoration: underline;
}

h2 {
  font: 100 42px "nyt-cheltenham", Georgia;
  color: #fff;
  padding: 0 0 20px 0;
  margin: 40px 0;
  border-bottom: solid 1px #666;
}

.collection {
  position: relative;
  text-align: left;
  height: 320px;
  font-family: "nyt-franklin", Arial;
  position: relative;
  display: block;
  margin: 0 0 20px 0;
  padding: 0 0 20px 0;
}

.collection:last-child {
  border-bottom: none;
}

.collection canvas,
.collection img {
  border: solid 1px #444;
  border-top-color: #000;
  border-bottom-color: #555;
  background: #000;
  position: absolute;
  left: 260px;
  top: 0;
}

.collection .description {
  font-size: 15px;
  line-height: 1.4em;
  margin: 0 20px 0 0;
  color: #999;
  width: 220px;
  position: absolute;
  top: 0;
  left: 0;
}

.collection .description h3 {
  display: inline;
  color: #ddd;
  font-size: 22px;
  font-weight: 200;
  margin: 0 0 0 0;
}

.description p {
  margin: 4px 0;
}

.description p.related {
  font-size: 12px;
  margin-top: 6px;
  padding-top: 6px;
  border-top: solid 1px #333;
}

.collection .collection-button {
  background: #2c2c2c;
  color: #666;
  border-radius: 2px;
  margin: 6px 0;
  padding: 1px 6px 0;
  display: inline-block;
  text-transform: uppercase;
  font-size: 9px;
  font-family: Arial;
}

.annotations {
  font-family: Arial;
  position: absolute;
  left: 255px;
  top: 225px;
  margin: 0;
  padding: 0;
  height: 50px;
}

.annotations li {
  position: absolute;
  top: 10px;
  margin: 0;
  list-style-type: none;
  padding: 10px 0 0 10px;
}

.annotation {
  position: relative;
  background: #222;
  font-size: 11px;
  line-height: 12px;
  color: #888;
  width: 90px;
  height: 50px;
  -webkit-text-size-adjust: 85%;
  text-shadow: 0 1px 0 #000;
}

.annotation:before {
  position: absolute;
  content: "";
  display: block;
  width: 10px;
  top: 0;
  left: -20px;
  height: 60px;
  border-right: solid 10px #222;
  background: none;
  background-image: -webkit-gradient(linear, left top, right top, from(rgba(34,34,34,0)), to(#222));
  background-image: -webkit-linear-gradient(left, rgba(34,34,34,0), #222);
  background-image: -moz-linear-gradient(left, rgba(34,34,34,0), #222);
  background-image: -o-linear-gradient(left, rgba(34,34,34,0), #222);
  background-image: linear-gradient(to right, rgba(34,34,34,0), #222);
}

.annotation-bar {
  position: absolute;
  min-width: 1px;
  left: 11px;
  right: -1px;
  top: 0;
  border-bottom: solid 1px;
  border-right: solid 1px;
  border-left: solid 1px;
  border-color: #666;
  height: 3px;
}

.collection-fingerprints {
  margin-top: 80px;
}

.collection-fingerprint {
  background-image: url(http://graphics8.nytimes.com/newsgraphics/2013/09/13/fashion-week-editors-picks/e2e355157a66c53141657c4af5431fed6add83f7/fingerprints.jpg);
  border-bottom-color: #777;
  border-top-color: #000;
  border: solid 1px #555;
  display: inline-block;
  height: 39px;
  margin: 0 30px 40px 0;
  padding: 0;
  position: relative;
  width: 90px;
}

.collection-fingerprint span {
  position: absolute;
  bottom: 46px;
  color: #999;
  font: 11px Arial;
}

.collection-fingerprint:hover span {
  text-decoration: underline;
}

.footer {
  position: absolute;
  bottom: 0;
  width: 100%;
  padding-top: 20px;
  border-top: solid 1px #444;
  font: 11px sans-serif;
  background-color: #2e2e2e;
}

.footer-content {
  margin: 0 5%;
  padding-bottom: 20px;
}

#fullscreen {
  background: #222;
  color: #777;
  font: 11px arial;
  padding: 6px;
}

.share-tools {
  float: left;
  margin-left: 2em;
  padding: 0;
  margin: 0 0 0 3em;
}

.share-tool {
  background: none;
  float: left;
  margin: 0;
  padding-left: 0;
  padding-right: 6px;
  list-style: none;
  cursor: pointer;
}

.share-tool:last-child {
  padding-right: 0;
}

.share-tool a {
  width: 20px;
  height: 20px;
  background-repeat: no-repeat;
  padding: 0;
  text-indent: -10000px;
  overflow: hidden;
  display: block;
}

.share-tool a { background-image: url(http://graphics8.nytimes.com/newsgraphics/2013/09/13/fashion-week-editors-picks/e2e355157a66c53141657c4af5431fed6add83f7/share.png); }
</style>
<!--[if lte IE 8]>
<style type="text/css">

body {
  width: 1100px;
  margin: 0 auto;
}

</style>
<![endif]-->

<script src="/static/fashion/js/jse7tmw.js"></script>
<style type="text/css">.tk-nyt-cheltenham{font-family:"nyt-cheltenham",sans-serif;}.tk-nyt-karnak-display-130124{font-family:"nyt-karnak-display-130124",sans-serif;}.tk-nyt-franklin{font-family:"nyt-franklin",sans-serif;}</style><link href="/static/fashion/css/jse7tmw-d.css" rel="stylesheet"><script type="text/javascript">try { Typekit.load(); } catch (e) {}</script>
<script src="/static/fashion/js/d3_lib.js"></script>
<script src="/static/js/d3.v3.3.10.min.js"></script>
<script src="/static/js/jquery-1.11.0.min.js"></script>
<script type="text/javascript" src="http://canvg.googlecode.com/svn/trunk/canvg.js"></script> 
<script type="text/javascript" src="http://canvg.googlecode.com/svn/trunk/rgbcolor.js"></script> 
<script type="text/javascript" src="http://canvg.googlecode.com/svn/trunk/StackBlur.js"></script>


<script type="text/javascript" src="http://www.nihilogic.dk/labs/canvas2image/canvas2image.js"></script>
<script type="text/javascript" src="http://www.nihilogic.dk/labs/canvas2image/base64.js"></script>

</head>


<body data-twttr-rendered="true">



<div class="header">
  <h1>Hydro Dataset Sorter</h1>
  <div class="dateline">
    <div class="byline">By <span>Jon</span></div>
    <div class="date">February 28, 2014</div>
  </div>
  <p class="header-summary">Based off geo-spatial data, this interface allows you to construct.
  </p><p><a id="fullscreen" href="#" style="">View Full Screen</a>
  </p>
</div>

<div class="graphic">
  <div class="editor-picks">
    
    <div class="collection" data-slug="michael-kors" data-size="54">
<!--      <a href="http://www.nytimes.com/fashion/runway/michael-kors/spring-2014-rtw/1?fingerprint=true"> -->
<!--         <canvas width="693" style="height: 225px; width: 693px;" height="225"></canvas></a> -->
        
        <div class="description">
        <h3>Hydro</h3>
        <p>Hydro electric readings. </p>
        <p class="related">Read more: <a href="http://runway.blogs.nytimes.com/2013/09/11/michael-kors-doesnt-break-a-sweat/">Michael Kors Doesnâ€™t Break a Sweat</a>
        <!-- <p><a href="http://www.nytimes.com/fashion/runway/michael-kors/spring-2014-rtw/1?fingerprint=true">View Collection</a> -->
      </p></div>
      
      <ul style="width: 693px;" class="annotations">
        <li data-range="[0,0]" style="left:0px;width:13px;">
          <div class="annotation">Note the details of this card</div>
          <div class="annotation-bar"></div>
        </li>
        <li data-range="[10,10]" style="left:132px;width:13px;">
          <div class="annotation">This element highlights the benefit of open data</div>
          <div class="annotation-bar"></div>
        </li>
        <li data-range="[26,26]" style="left:345px;width:13px;">
          <div class="annotation">This card was a custom creation</div>
          <div class="annotation-bar"></div>
        </li>
        <li data-range="[42,42]" style="left:558px;width:13px;">
          <div class="annotation">This item is controversial.</div>
          <div class="annotation-bar"></div>
        </li>
      </ul>
    </div>
    
    
    
<div class="footer">
  <div class="footer-content">
    Elements sourced from Hydro Electric Dataset
  </div>
</div>

<!--     <div id='svg-container'> <svg xmlns="http://www.w3.org/2000/svg" version="1.1"> <rect x="50" y="20" width="150" height="100" style="fill:blue;stroke:pink;stroke-width:5;fill-opacity:0.1;stroke-opacity:0.9" /> </svg> </div>-->
<!--    <canvas id="svg-canvas" width="150" height="100"></canvas>-->
    
    <div id='the_cards'>
<!--          <img id="MyPix" src=""/> -->
    </div>
    

<!--[if gt IE 8]><!-->
<script>(function() {


var width,
    height = 225;


var         j_image_width=400;
var         j_image_height=225;

var graphic = d3.select(".graphic");

var collection = graphic.selectAll(".collection")
    .datum(function(d) {
      return {
        slug: this.getAttribute("data-slug"),
        size: this.getAttribute("data-size")
      };
    });

var canvas = collection
     .insert("a", ".description")
//     .attr("href", function(d) { return "http://www.nytimes.com/fashion/runway/" + d.slug + "/spring-2014-rtw/1?fingerprint=true"; })
     .attr("id", "the_canvas")
     .append("canvas");

var pixelRatio = 1,
    storeRatio = 1;

if (window.devicePixelRatio >= 2
    && screen.availWidth >= 1280 // iPad can’t even handle it
    && canvas.node().getContext("2d").webkitBackingStorePixelRatio !== 2) { // Safari can’t even
  pixelRatio = 2;
  storeRatio = 2;
}

canvas
    .attr("height", height * storeRatio)
    .style("height", height + "px");

var description = collection.select(".description"),
    annotations = collection.select(".annotations");

annotations.selectAll("li")
    .datum(function() {
      return {
        range: JSON.parse(this.getAttribute("data-range"))
      };
    });

d3.select(window)
    .on("scroll", scroll)
    .on("resize", resize);

d3.select("#fullscreen")
    .style("display", null)
    .on("click", function requestFullScreen() {
      d3.event.preventDefault();

      var element = document.documentElement;
      if (element.requestFullscreen) element.requestFullscreen();
      else if (element.mozRequestFullScreen) element.mozRequestFullScreen();
      else if (element.webkitRequestFullscreen) element.webkitRequestFullscreen();

      function cancelFullScreen() {
        d3.event.preventDefault();
        if (document.cancelFullScreen) document.cancelFullScreen();
        else if (document.mozCancelFullScreen) document.mozCancelFullScreen();
        else if (document.webkitCancelFullScreen) document.webkitCancelFullScreen();

        d3.select(this)
            .text("View Full Screen")
            .on("click", requestFullScreen);
      }

      d3.select(this)
          .text("Exit Full Screen")
          .on("click", cancelFullScreen);
    });

resize();

// Recompute bounding boxes due to reflow.
function resize() {
  width = parseInt(graphic.style("width")) - 260;

  annotations
      .style("width", width + "px");

  collection.select("canvas")
      .attr("width", width * storeRatio)
      .style("width", width + "px")
      .each(function(d) {
        var context = d.context = this.getContext("2d");
        context.scale(storeRatio, storeRatio);
        context.strokeStyle = "rgba(0,0,0,0.8)";
        if (d.enabled) d.resize();
      });

  scroll();
}

// Recompute which canvases are visible in the viewport.
function scroll() {
  var dy = innerHeight;
  if (!canvas
      .filter(function() {
        var box = this.getBoundingClientRect();
        return box.bottom > 0 && box.top < dy;
      })
      .each(enableFisheye)
      .empty()) {
    canvas = canvas.filter(function(d) { return !d.enabled; });
  }
}

function enableFisheye(d) {
  d.enabled = true;

  var that = this,
      link = that.parentNode,
      div = link.parentNode,
      touchtime;

  var normalWidth = width / d.size,
      image = new Image,
      imageWidth = j_image_width,
      imageHeight = j_image_height,
      desiredDistortion = 0,
      desiredFocus,
      progress = 0,
      idle = true;

  var x = fisheye()
      .distortion(0)
      .extent([0, width]);

  var annotation = d3.select(div).selectAll("li");

//  image.src = "http://graphics8.nytimes.com/newsgraphics/2013/09/13/fashion-week-editors-picks/assets/thumbs-" + pixelRatio + "/" + d.slug + ".jpg";
  image.src = "/img/mk.png";
//  image.onload = initialize;

  // Progress bar
  d3.timer(function() {
    if (progress < 0) return true;
    var context = d.context;
    context.clearRect(0, 0, width, 2);
    context.fillStyle = "#777";
    context.fillRect(0, 0, ++progress, 2);
  });

  d.resize = function() {
    var f = x.focus() / x.extent()[1],
        d1 = imageWidth / normalWidth - 1,
        d0 = x.distortion() / d1;
    normalWidth = width / d.size;
    x.distortion(d0 * d1).extent([0, width]).focus(f * width);
    render();
  };

  function initialize() {
    progress = -1;

    d3.select(that)
        .on("mousedown", mousedown)
        .on("mouseover", mouseover)
        .on("mousemove", mousemove)
        .on("mouseout", mouseout)
        .on("touchstart", touchstart)
        .on("touchmove", mousemove)
        .on("touchend", mouseout);

    generate_cards();
    render();
  }
  
var the_dataset;
var the_teams_data;
//the_teams_url="/static/js/teams.json";
//d3.json(the_teams_url, function(json) {
//    the_dataset=json.results;
//    initialize();
//});
the_dataset_url="/static/js/data1000.json";
var the_dataset_data;
d3.json(the_dataset_url, function(json) {
    the_dataset=json.results;
    initialize();
});
  
  
  

var imageContainer=[];
var imageElement="";

  function randomInt(the_size) {
      var the_fraction=Math.random();
      var the_num=parseInt(the_fraction*the_size);
      return the_num;
  }
  
  function generate_cards() {
      var canvas2 = document.createElement('canvas');
      canvas2.width = j_image_width;
      canvas2.height = j_image_height;
      canvas2.id = "canvas2";
      
       var nodes8=[]
       b = {id: "xxx",x:0,y:0,value:"0"}
 
       var images_array=[];
       
       // Generate image for each potential
       for (var ii = 0, n = d.size; ii < n+1; ++ii) { //Bug generate 1 more!
           nodes8.push(b);
       };
 
           // CREATE n separate svg blocks to be rendered
             var svgContainer = d3.select("body")
                    .data(nodes8)
                    .enter()
             .append("svg")
                              .attr("id",function(d,i) {
                                            one_shift=i-1;
                                            return "raw_svg_"+one_shift;
                                            })
                              .attr("width",j_image_width)
                              .attr("height",j_image_height)
                              .style("display","block")
                              ;
                                      
                                      
       for (var ii = 0, n = d.size; ii < n; ++ii) {
            //################################### CARD
            
            // Slip in json style data 
            var nodes19=[]
            data_index=randomInt(the_dataset.length);
            data_index=ii;
            b=the_dataset[data_index];
            
            //b = {id: "xxx",x:0,y:0,value:"0"}
            nodes19.push(b);
             
             var svgG=d3.select("#raw_svg_"+ii).selectAll('svg')
                    .data(nodes19)
                .enter().append("g")
                    .attr("id","container_sheet")
                    ;
                    
             var rect_card = svgG.append("rect")
                .attr("id", "raw_rect")
                .attr("x", 0)
                .attr("y", 0)
                .attr("width", j_image_width)
               .attr("height", j_image_height)
               .style("fill", "black")
               .style("stroke", "pink")
               .style("stroke-width", 5)
               .style("fill-opacity", 0.1)
               .style("stroke-opacity", 0.9) ;
               
//nope       var card_image= svgG.append("img")
//nope        .attr("xlink:href", "https://canadianopendataexperience.com/system/uploads/team/logo/58/large_icon.png")
//nope        .attr("id", "clip_image")
//nope        .attr("class", "clip_image_class")
//nope        .attr("x",0) //patch: 5 pixel offset issue
//nope        .attr("y",0)
//nope        .attr("width",j_image_width)
//nope        .attr("height",j_image_height)
//nope//        .style("opacity",".3")
//nope        ;
               
             var the_pointer=25;
             var card_title= svgG.append("svg:text")
                             .attr("id", "the_score")
                             .text(function(d,i) { 
                                 var temp=ii+1;
                             return d.title;})
                             .attr("dx", function(d) { return 5;})
                             .attr("dy", function(d) { return the_pointer;})
                             .style("fill",function(d) { return "white";})
                             .style("font-size","28px");
                             
             bbox = card_title.node().getBBox();
             the_pointer=the_pointer+bbox.height+3;
             
             
             the_text="This is a really long description which I will wrap myself ok then  ";
             the_text=the_dataset[data_index].description;
             
             var myRegexp = /(.{1,40})\s/g;
             var match = myRegexp.exec(the_text);
             var the_new_text=""
             while (match != null) {
                 the_new_text=match[0];
                 match = myRegexp.exec(the_text);
                 
                 if (the_pointer<200) {
                     var card_description= svgG.append("svg:text")
                             .attr("id", "the_score")
                             .text(function(d,i) { return the_new_text;})
                             .attr("dx", function(d) { return 5;})
                             .attr("dy", function(d) { return the_pointer;})
                             .style("fill",function(d) { return "white";})
                             .style("font-size","23px");
                 }
                             
                 bbox = card_description.node().getBBox();
                 the_pointer=the_pointer+bbox.height+2;
             }
             
             
             the_pointer=the_pointer+6;
             
             
             var card_link= svgG.append("svg:text")
                             .attr("id", "the_score")
                             .text(function(d,i) { return "Link: "+d.url;})
                             .attr("dx", function(d) { return 10;})
                             .attr("dy", function(d) { return the_pointer;})
                             .style("fill",function(d) { return "white";})
                             .style("font-size","18px");
                             
             //################################### CARD
       };
                             
       
       // Generate image for each potential
       for (var ii = 0, n = d.size; ii < n; ++ii) {
           console.log("Creating custom at "+ii);
//works hardcoded           var svgContent="<svg xmlns='http://www.w3.org/2000/svg' version='1.1'><rect x='0' y='0' width='"+j_image_width+"' height='"+j_image_height+"' style='fill:blue;stroke:pink;stroke-width:5;fill-opacity:0.1;stroke-opacity:0.9' /> </svg>";
//works hardcoded           svgContent=svgContent.trim();
           
           
//           $('#raw_svg_'+ii).css("display","block");
            var container = $('#raw_svg_'+ii).html();
           svgContent=container.trim();
           $('#raw_svg_'+ii).css("display","none");
           
           canvg(canvas2, svgContent);
           var theImage = canvas2.toDataURL('image/jpeg');
           images_array.push(theImage);
       };
       
       
    
      var card_container=d3.select("#the_cards");
      // Append images
      card_container.selectAll("img")
        .data(nodes8)
        .enter().append("img")
        .attr("id",function(d,i) {return "MyPix_"+i})
        .attr("src","")
        .style("display","none")
        ;
        
       for (var i = 0, n = d.size; i < n; ++i) {
           imageElement = document.getElementById("MyPix_"+i);  // Get the img object.
           imageElement.src = images_array[i];  //theImage;    
//           imageElement.src = theImage;    
           imageContainer.push(imageElement);
       };
      
//      imageElement = document.getElementById("MyPix");  // Get the img object.
//      imageElement.src = theImage;    
//      imageContainer.push(imageElement);

  };

  function render() {
    console.log("Render called");
    annotation
        .style("left", function(d) { return Math.round(x(d.range[0] * normalWidth)) - 4 + "px"; })
        .style("width", function(d) { return Math.round(x((d.range[d.range.length - 1] + 1) * normalWidth)) - Math.round(x(d.range[0] * normalWidth)) - 1 + "px"; })
      .select(".annotation")
        .style("left", function(d) { return Math.min(0, (width - 90) - (x(d.range[0] * normalWidth) - 4)) + "px"; });

    var context = d.context;
    context.clearRect(0, 0, width, height);
    

   for (var i = 0, n = d.size; i < n; ++i) {
      var x0 = x(i * normalWidth),
          x1 = x((i + 1) * normalWidth),
          dx = Math.min(imageWidth, x1 - x0);
          
      //void drawImage(
      //  in nsIDOMElement image, (Any)
      //  in float sx, // top left sub X
      //  in float sy, // top left sub Y
      //  in float sw, //          sub width
      //  in float sh, //          sub height
      //  in float dx, // destionation top left X
      //  in float dy, // destionation top left Y
      //  in float dw, // destionation width
      //  in float dh  // destination height
      
      imageElement=imageContainer[i];
      context.drawImage(imageElement, 0, 0, imageElement.width, imageElement.height, x0, 0, dx, height);
//      context.drawImage(image, Math.round((i * imageWidth + (imageWidth - dx) / 2) * pixelRatio), 0, dx * pixelRatio, imageHeight * pixelRatio, x0, 0, dx, height);
      
      context.beginPath();
      context.moveTo(x0, 0);
      context.lineTo(x0, height);
      context.stroke();
    }

    context.strokeRect(0, 0, width, height);
  }

  function move() {
    if (idle) d3.timer(function() {
      var currentDistortion = x.distortion(),
          currentFocus = currentDistortion ? x.focus() : desiredFocus;
      idle = Math.abs(desiredDistortion - currentDistortion) < .01 && Math.abs(desiredFocus - currentFocus) < .5;
      x.distortion(idle ? desiredDistortion : currentDistortion + (desiredDistortion - currentDistortion) * .14);
      x.focus(idle ? desiredFocus : currentFocus + (desiredFocus - currentFocus) * .14);
      render();
      return idle;
    });
  }

  function mouseover() {
    desiredDistortion = imageWidth / normalWidth - 1;
    mousemove();
  }

  function mouseout() {
    desiredDistortion = 0;
    mousemove();
  }

  function mousemove() {
    desiredFocus = Math.max(0, Math.min(width - 1e-6, d3.mouse(that)[0]));
    move();
  }

  function mousedown() {
    var m = Math.max(0, Math.min(width - 1e-6, d3.mouse(that)[0]));
    for (var i = 0, n = d.size; i < n && x(i * normalWidth) < m; ++i);
//    link.href = "http://www.nytimes.com/fashion/runway/" + d.slug + "/spring-2014-rtw/" + i + "?fingerprint=true";
  }

  function touchstart() {
    d3.event.preventDefault();
    mouseover();
    if (d3.event.touches.length === 1) {
      var now = Date.now();
//      if (now - touchtime < 500) mousedown(), link.click();
      if (now - touchtime < 500) mousedown();
      touchtime = now;
    }
  }
}

function fisheye() {
  //org max 1 dist 3
  var min = 0,
      max = 3,
      distortion = 6,
      focus = 0;

  function G(x) {
    return (distortion + 1) * x / (distortion * x + 1);
  }

  function fisheye(x) {
    var Dmax_x = (x < focus ? min : max) - focus,
        Dnorm_x = x - focus;
    return G(Dnorm_x / Dmax_x) * Dmax_x + focus;
  }

  fisheye.extent = function(_) {
    if (!arguments.length) return [min, max];
    min = +_[0], max = +_[1];
    return fisheye;
  };

  fisheye.distortion = function(_) {
    if (!arguments.length) return distortion;
    distortion = +_;
    return fisheye;
  };

  fisheye.focus = function(_) {
    if (!arguments.length) return focus;
    focus = +_;
    return fisheye;
  };

  return fisheye;
}

})();




</script>

<style>
#svg_element{
transform: translate(0px,0px);
-ms-transform: translate(0px,0px); /* IE 9 */
-webkit-transform: translate(0px,0px); /* Safari and Chrome */
-o-transform: translate(0px,0px); /* Opera */
-moz-transform: translate(0px,0px); /* Firefox */
z-index:99999;
position:absolute;
top:0;
left:0;
}
</style>


<div id="svg_layer">
<script>

 var j_image_width=200;
 var j_image_height=150;
 // Get size of window
 var nodes9=[]
 b = {id: "xxx",x:0,y:0,value:"0"}
 nodes9.push(b);
 
 var svg_width = window.innerWidth;
 var svg_height = window.innerHeight;
// svg_width=300;
// svg_height=300;

 var svgContainer = d3.select("body").append("svg")
                                     .attr("id", "svg_element")
                                     .attr("width", svg_width)
                                     .attr("height", svg_height)
//                                     .style("pointer-events","none")
                                     .style("pointer-events","none")
                                     ;
 var svgG=svgContainer.selectAll('svg')
                .data(nodes9)
            .enter().append("g")
                .attr("id","container_sheet");
                
                
 var svgCard=svgContainer.selectAll('svg')
                .data(nodes9)
            .enter().append("g")
                .style("display","none")
                .attr("id","container_card");
 var svgScore=svgContainer.selectAll('svg')
                .data(nodes9)
            .enter().append("g")
                .attr("id","container_score")
                .attr("display","none");

 var rect_card = svgCard.append("rect")
                            .attr("x", -j_image_width/2)
                            .attr("y", -j_image_width/2)
                            .attr("width", j_image_width)
                            .attr("height", j_image_height)
                            .style("fill", function(d) { return "grey"; })
                            .style("opacity", "0.3")
                            ;
                         
 var rect_background = svgG.append("rect")
                            .attr("x", 0)
                            .attr("y", 0)
                            .attr("width", svg_width)
                            .attr("height", svg_height)
                            .style("fill", function(d) { return "yellow"; })
                            .style("opacity", "0")
                            ;
                            
 var text_score2= svgScore.append("svg:text")
                         .attr("id", "the_score")
                         .text(function(d) { 
                                temp="";
                                if (d.value>=0) { temp="+";}
                                return temp+d.value;})
                         .attr("dx", function(d) { return -d.value.length;})
                         .attr("dy", function(d) { return 0;})
//                         .attr("dy", function(d) { return -d.size/2-4;})
                         .style("fill",function(d) { return "white";})
                         .style("font-size","44px");
 d3.select("#container_score").attr("transform", function(d) { return "translate(" + svg_width/2 + ", 180)"; });    
     
                        
                        
                            
                            
$('#the_canvas').on('mousedown', function(event){
    //    event.stopPropagation();
    $('#svg_element').css("pointer-events","all");
});

$('#svg_element').on('mouseup', function(event){
    $('#svg_element').css("pointer-events","none");
    $('#container_card').css("display","none");
    $('#container_score').css("display","none");
});


function translate_to_xy(the_translate) {
   var element2=the_translate
   var splittedd = element2.split(",");
   var xx2 = ~~splittedd [0].split("(")[1];
   var yy2 = ~~splittedd [1].split(")")[0];
   return {x: xx2, y: yy2};
}


function move(mouse) {
    d3.select("#container_card") .attr("transform", function(d) { return "translate(" + mouse[0] + "," + mouse[1] + ")"; });    
  }


svgContainer.on("mousemove", function() {
    var mouse = d3.mouse(this);
    move(mouse);
    
    $('#container_card').css("display","block");
    $('#container_score').css("display","block");
    
//works    d3.select("#the_score").text(function(d) { return "ok";}) 
                                
    $('#the_score').text(function() { 
//                                text=parseInt(d3.mouse(this)[0]);
//                                text=parseInt(svg_width/2-d3.mouse(this)[0]);
                                maxi=svg_width/2-10;
                                percent=d3.mouse(this)[0]/maxi*100;
                                if (percent>100) { percent=100;}
                                text=parseInt(percent);
                                temp="";
                                if (text>=0) { temp="+";}
                                else { temp=""; }
                                return temp+text;});
                                
    
});


//################## TEXT DIGIT





</script>
</div>




</body>
